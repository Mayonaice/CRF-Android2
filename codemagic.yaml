workflows:
  android-build:
    name: Android Debug Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      flutter: 2.8.1 # Menggunakan Flutter versi stabil yang lebih lama
      java: 11
    scripts:
      - name: Setup and build APK
        script: |
          # Tampilkan versi Flutter dan Java
          echo "Flutter version:"
          flutter --version
          echo "Java version:"
          java -version
          
          # Buat pubspec.yaml baru yang kompatibel dengan Flutter 2.8.1
          cat > pubspec.yaml << 'EOL'
          name: crf_android
          description: CRF Android Application
          publish_to: 'none'
          version: 1.0.0+1
          
          environment:
            sdk: ">=2.12.0 <3.0.0"
          
          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.2
            http: ^0.13.4
            shared_preferences: ^2.0.11
            intl: ^0.17.0
            flutter_secure_storage: ^5.0.2
            connectivity_plus: ^2.2.0
            package_info_plus: ^1.3.0
            device_info_plus: ^3.2.1
            path_provider: ^2.0.8
          
          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^1.0.0
          
          flutter:
            uses-material-design: true
            assets:
              - assets/images/
              - assets/fonts/
          EOL
          
          # Buat main.dart minimal
          mkdir -p lib
          cat > lib/main.dart << 'EOL'
          import 'package:flutter/material.dart';
          
          void main() {
            runApp(const MyApp());
          }
          
          class MyApp extends StatelessWidget {
            const MyApp({Key? key}) : super(key: key);
          
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                title: 'CRF Android',
                theme: ThemeData(primarySwatch: Colors.blue),
                home: const MyHomePage(),
              );
            }
          }
          
          class MyHomePage extends StatelessWidget {
            const MyHomePage({Key? key}) : super(key: key);
          
            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(title: const Text('CRF Android')),
                body: const Center(
                  child: Text('Build berhasil', style: TextStyle(fontSize: 24)),
                ),
              );
            }
          }
          EOL
          
          # Buat folder assets
          mkdir -p assets/images
          mkdir -p assets/fonts
          
          # Update android/app/build.gradle untuk minSdkVersion
          if [ -f "android/app/build.gradle" ]; then
            sed -i '' 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/' android/app/build.gradle
          fi
          
          # Get dependencies
          flutter pub get
          
          # Build APK dengan verbose mode
          echo "Building APK with verbose mode..."
          flutter build apk --debug -v
          
          # Cek hasil build
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "✅ APK build berhasil!"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "❌ APK build gagal!"
            echo "Mencoba build lagi dengan flag tambahan..."
            flutter build apk --debug --no-shrink -v
            
            if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
              echo "✅ APK build berhasil pada percobaan kedua!"
              ls -lh build/app/outputs/flutter-apk/app-debug.apk
            else
              echo "❌ APK build masih gagal!"
              exit 1
            fi
          fi
    artifacts:
      - build/app/outputs/flutter-apk/app-debug.apk 