workflows:
  android-build:
    name: Android Debug Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      flutter: 3.10.0  # Use a more stable Flutter version
      java: 11  # Use Java 11 for compatibility
    scripts:
      - name: Create temporary project and fix dependencies
        script: |
          # Create a temporary Flutter project with working Android configuration
          echo "Creating temporary Flutter project..."
          mkdir -p /tmp/flutter_temp
          cd /tmp/flutter_temp
          flutter create --org com.advantage --project-name temp_project .
          cd -
          
          # Create backup of original android folder
          echo "Backing up original android folder..."
          mv android android_original
          
          # Copy the template android folder from the temporary project
          echo "Copying template android folder..."
          cp -r /tmp/flutter_temp/android .
          
          # Update package name in template
          echo "Updating package name..."
          find android -type f -name "*.xml" -o -name "*.gradle" -o -name "*.java" -o -name "*.kt" | xargs sed -i '' 's/com.advantage.temp_project/com.advantage.crf_android/g'
          
          # Create local.properties
          echo "flutter.sdk=$HOME/programs/flutter" > android/local.properties
          
          # Create a backup of pubspec.yaml
          cp pubspec.yaml pubspec.yaml.bak
          
          # Create a new compatible pubspec.yaml with downgraded dependencies
          cat > pubspec.yaml << 'EOL'
          name: crf_android
          description: A new Flutter project.
          publish_to: 'none'
          version: 1.0.0+1
          
          environment:
            sdk: '>=2.17.0 <3.0.0'
          
          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.2
            http: ^0.13.5
            shared_preferences: ^2.0.15
            intl: ^0.17.0
            flutter_secure_storage: ^5.1.2
            connectivity_plus: ^2.3.9
            package_info_plus: ^1.4.3
            device_info_plus: ^4.1.3
            mobile_scanner: ^2.1.0
            qr_mobile_vision: ^4.0.0
            qr_code_scanner: ^1.0.0
            crypto: ^3.0.2
            android_id: ^0.1.3+1
            dio: ^4.0.6
            qr_flutter: ^4.0.0
            platform: ^3.1.0
          
          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^2.0.0
            flutter_launcher_icons: ^0.10.0
          
          flutter:
            uses-material-design: true
            assets:
              - assets/images/
              - assets/fonts/
          
          flutter_launcher_icons:
            android: true
            ios: false
            image_path: "assets/images/app_icon.png"
            adaptive_icon_background: "#0056A4"
            adaptive_icon_foreground: "assets/images/app_icon.png"
            min_sdk_android: 21
            remove_alpha_ios: true
            web:
              generate: false
            windows:
              generate: false
            macos:
              generate: false
          EOL
          
      - name: Build APK
        script: |
          # Get dependencies
          flutter pub get
          
          # Clean the project
          flutter clean
          
          # Build debug APK
          echo "Building debug APK..."
          flutter build apk --debug
          
          # Verify APK exists and show its size
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "✅ Debug APK created successfully"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "❌ No APK found!"
            exit 1
          fi
          
          # Restore original pubspec.yaml but keep the new android folder
          mv pubspec.yaml.bak pubspec.yaml
    artifacts:
      - build/app/outputs/flutter-apk/app-debug.apk 